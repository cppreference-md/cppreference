---
import { codeToHtml } from "shiki";

export interface Props {
  header: string;
  content: string;
}

const { header, content } = Astro.props;

function parseDeclarations(content: string) {
  const lines = content
    .trim()
    .split("\n")
    .filter((line) => line.trim());
  const declarations: Array<{
    number: string;
    code: string;
    version?: string;
  }> = [];

  let currentDeclaration = "";
  let currentNumber = "";
  let currentVersion = "";
  let inDeclaration = false;

  for (const line of lines) {
    const trimmedLine = line.trim();

    const numberMatch = trimmedLine.match(/^\((\S+)\)(?:\s+\(since (.+?)\))?$/);
    if (numberMatch) {
      if (currentDeclaration && currentNumber) {
        declarations.push({
          number: currentNumber,
          code: currentDeclaration.trim(),
          version: currentVersion,
        });
      }

      currentNumber = numberMatch[1];
      currentVersion = numberMatch[2] || "";
      currentDeclaration = "";
      inDeclaration = true;
      continue;
    }

    if (inDeclaration) {
      currentDeclaration += line + "\n";
    } else if (!currentNumber) {
      currentDeclaration += line + "\n";
      currentNumber = "1";
      inDeclaration = true;
    }
  }

  if (currentDeclaration && currentNumber) {
    declarations.push({
      number: currentNumber,
      code: currentDeclaration.trim(),
      version: currentVersion,
    });
  }

  return declarations;
}

const declarations = parseDeclarations(content);

const highlightedDeclarations = await Promise.all(
  declarations.map(async (decl) => {
    const [lightHighlighted, darkHighlighted] = await Promise.all([
      codeToHtml(decl.code, {
        lang: "cpp",
        theme: "github-light",
      }),
      codeToHtml(decl.code, {
        lang: "cpp",
        theme: "github-dark",
      }),
    ]);

    return {
      ...decl,
      lightHighlighted,
      darkHighlighted,
    };
  }),
);
---

<div class="declaration-table not-content">
  <div class="declaration-header">
    Defined in header &lt;<span class="header-name">{header}</span>&gt;
  </div>

  <div class="declarations-container">
    {
      highlightedDeclarations.map((decl) => (
        <div class="declaration-row">
          <div class="declaration-content">
            <div class="light-code" set:html={decl.lightHighlighted} />
            <div class="dark-code" set:html={decl.darkHighlighted} />
          </div>
          <div class="declaration-meta">
            {decl.version && (
              <span class="declaration-version">(since {decl.version})</span>
            )}
            <span class="declaration-number">({decl.number})</span>
          </div>
        </div>
      ))
    }
  </div>
</div>

<style>
  .declaration-table {
    border: 1px solid #e1e5e9;
    border-radius: 6px;
    margin: 1.5rem 0;
    overflow: hidden;
    background: white;
  }

  .declaration-header {
    background: #f6f8fa;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e1e5e9;
    font-size: 0.9rem;
    color: #656d76;
  }

  .header-name {
    color: #0969da;
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
  }

  .declarations-container {
    background: white;
  }

  .declaration-row {
    display: flex;
    align-items: flex-start;
    border-bottom: 1px solid #e1e5e9;
    padding: 1rem;
    gap: 1rem;
    align-items: center;
  }

  .declaration-row:last-child {
    border-bottom: none;
  }

  .declaration-content {
    flex: 1;
    min-width: 0;
  }

  .declaration-meta {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    flex-shrink: 0;
    margin: 0;
  }

  .declaration-number {
    font-size: 0.9rem;
    color: #656d76;
    font-weight: 500;
  }

  .declaration-version {
    font-size: 0.85rem;
    color: #1a7f37;
    background: #dafbe1;
    padding: 0.15rem 0.5rem;
    border-radius: 12px;
    white-space: nowrap;
  }

  .light-code {
    display: block;
  }

  .dark-code {
    display: none;
  }

  :root[data-theme="dark"] .light-code {
    display: none;
  }

  :root[data-theme="dark"] .dark-code {
    display: block;
  }

  :global(.declaration-content pre),
  :global(.declaration-content pre[class*="shiki"]) {
    margin: 0 !important;
    padding: 0 !important;
    background: transparent !important;
    background-color: transparent !important;
    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    font-size: 0.9rem !important;
    line-height: 1.5 !important;
    overflow: visible !important;
  }

  :global(.declaration-content code),
  :global(.declaration-content code[class*="shiki"]) {
    background: transparent !important;
    background-color: transparent !important;
    padding: 0 !important;
    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    display: block !important;
  }

  :root[data-theme="dark"] .declaration-table {
    border-color: #30363d;
    background: #0d1117;
  }

  :root[data-theme="dark"] .declaration-header {
    background: #161b22;
    border-color: #30363d;
    color: #8b949e;
  }

  :root[data-theme="dark"] .header-name {
    color: #58a6ff;
  }

  :root[data-theme="dark"] .declarations-container {
    background: #0d1117;
  }

  :root[data-theme="dark"] .declaration-row {
    border-color: #21262d;
  }

  :root[data-theme="dark"] .declaration-number {
    color: #8b949e;
  }

  :root[data-theme="dark"] .declaration-version {
    color: #238636;
    background: #1a2e1a;
  }

  @media (max-width: 768px) {
    .declaration-row {
      flex-direction: column;
      gap: 0.75rem;
    }

    .declaration-meta {
      align-items: center;
      align-self: flex-start;
    }

    .declaration-version {
      margin-left: 0.5rem;
    }
  }
</style>
